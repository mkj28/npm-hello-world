version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: mkj28/npmhelloworld
    working_directory: ./
    dockerfile: Dockerfile
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
  BuildingCIDockerImage:
    title: Building CI Docker Image
    type: build
    image_name: mkj28/npmhelloworld-ci
    working_directory: ./
    dockerfile: Dockerfile-ci
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
  RunningUnitTests:
    title: Running Unit Tests
    image: '${{BuildingCIDockerImage}}'
    working_directory: IMAGE_WORK_DIR
    commands:
      - node --version
      - npm run lint
    on_success:
      metadata:
        set:
          - '${{BuildingDockerImage.imageId}}':
              - CF_QUALITY: true
              - lint: true
              - CodeCoverage: 80%
    on_fail:
      metadata:
        set:
          - '${{BuildingDockerImage.imageId}}':
              - CF_QUALITY: false
              - lint: false
  TaggingAsLatest:
    type: push
    title: Tag as Latest
    candidate: ${{BuildingDockerImage}}
    tag: latest
    registry: quay
    when:
      branch:
        only:
          - master

